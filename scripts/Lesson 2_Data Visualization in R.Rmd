---
title: Data Visualization in R
author: "Xuelin (Lin) Luo^[Statistical consultant, xuelin@uga.edu]"
date: "`r Sys.Date()`"
output:
  html_document: default
chunk_output_type: console
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE,fig.width = 6, fig.height = 4}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)

library(ggplot2)
library(tidyverse)
library(ggpubr)
setwd("~/LXL/Arg_Stat/Notes of ideas/R workshops/Lesson 2-Data Visualization in R")
crop <- read.csv("crop.csv",colClasses=c(rep("factor",4),"numeric","numeric"))
```


### **I.Data Visualization**

Data visualization is an important part of data analysis. It can help us have a big idea of the characteristics of the data before any statistical analysis, and demonstrate the key results at a glance.In this lesson, we will introduce some basic plots and the logic of **ggplot** to help you start your data visualization journey using R.

*R Graph Gallery*: the most extensive compilation of R-generated graphs on the web. <https://r-graph-gallery.com/>


#### **Some Basic plots**

 1. **Basic box plots**

```{r}
boxplot(crop$yield_ms~crop$density)
# Change axes labels and add title
boxplot(crop$yield_ms~crop$density, main="Peanut Yield Data",
        xlab="Plant Density", ylab="Yield (lb)/Plot")
```

 2. **Basic histograms**

```{r}
hist(crop$yield_ms)
# Change binswith according to Warning message
hist(crop$yield_ms, breaks=20)

low<-subset(crop,density=="Low") # subset() extracts specific rows/columns
high<-crop[crop$density=="High",]
hist(low$yield_ms)
hist(high$yield_ms)
```

 3. **Nice and easy error plots using *`ggerrorplot()`* in *`ggpubr`* library**

```{r}
ggerrorplot(crop, x="density", y="yield_ms", desc_stat = "mean_se") #Note the y axis truncation!
```

 4. **Plot mean and standard deviation**
 
 Plot mean and sd of yield of each fertilizer with two panels for two densities. **`ggbarplot()`** is in the **`ggpubr`** R package.

```{r}
ggbarplot(crop,x="density",y="yield_ms",fill="fertilizer",position=position_dodge(0.7),width=0.5,add="mean_sd",ylim=c(0,200))+
scale_fill_brewer(palette="Greys")
```

### II **ggplot2 package**

***`ggplot2`*** package is used map data to visual elements on your plot, to specify the kind of plot you want, and then subsequently to control the fine details of how it will be displayed. After tidying data (long format),there are usually three components to draw a plot:

* **Mapping**: set up connections between data and plot elements, called *aesthetic mappings*.

* **Geom**: a *geom* is type of plot. For example, *geom_point()* makes scatterplots, *geom_boxplot()* makes boxplots, and so on.

* **Details of plot**: if you don't specify anything further, like the scales, the labels of legends and axes, and other guides that help people to read the plot, *ggplot* will use a set of defaults, which may be not what you want to see. 

Every object constructed by *ggplot* is connected by a plus sign "+".

Introduction about ***ggplot*** <https://socviz.co/makeplot.html#how-ggplot-works>.


#### <span style="background-color: lightgray;">Example:</span> **Multiple histograms**

```{r}
#Together
crop %>%
  ggplot( mapping=aes(x=yield_ms, fill=fertilizer)) +
  geom_histogram(color="black", alpha=0.6, position = 'identity') +
  scale_fill_manual(values=c("blue","yellow","darkgreen"))  
#In multiple panels
crop %>%
  ggplot( aes(x=yield_ms, fill=fertilizer)) +
  geom_histogram(color="black", alpha=0.6, position = 'identity') +
  scale_fill_manual(values=c("blue","yellow","darkgreen")) +
  facet_wrap(~fertilizer)
#change binwidth from 30 to 20, and change labels for better understanding
crop %>%
  ggplot( aes(x=yield_ms, fill=fertilizer)) +
  geom_histogram(color="black", alpha=0.6, position = 'identity', bins=20) +
  scale_fill_manual(values=c("blue","yellow","darkgreen")) +
  facet_wrap(~fertilizer)+
  labs(x="Yield per plot", y="Frequency", fill="Density",
       title="Histograms of yield per fertilizer")+
  theme(plot.title = element_text(hjust = 0.5)) # Center title
```

**Practice**: How about if you want to see the histograms of two densities side by side, or overlaid? 

```{r}
crop %>%
  ggplot( aes(x=yield_ms, fill=density)) +
  geom_histogram(color="black", alpha=0.6, position = 'identity', bins=20) +
  scale_fill_manual(values=c("blue","yellow")) +
  facet_wrap(~density)+
  labs(x="Yield per plot", y="Frequency", fill="Density",
       title="Histograms of yield per density")+
  theme(plot.title = element_text(hjust = 0.5)) # Center title
```


#### <span style="background-color: lightgray;">Example:</span> **Plot interaction effect**

Does density effect on yield depend on fertilizer?

```{r}
ggplot(crop, aes(x = fertilizer, y = yield_ms, 
                     shape = density,
                     group = density,
                     color = density)) +
  stat_summary(fun = "mean", geom = "point", size = 3) +
  stat_summary(fun = "mean", geom = "line") +
  stat_summary(fun.data = "mean_se", geom = "errorbar", width = .2) +
  scale_color_manual(values = c("blue", "darkorange")) +
  theme_classic()
```

**Saving your plots**
```{r}
ggsave(filename="Interaction effect.png") 
ggsave(filename="Interaction effect2.png", width=6, height=4, dpi=300) 
# options width, height, units = c("in", "cm", "mm"), dpi = 300 can be used to meet the graphic requirements of different journals.
```


### **II. Practices** <https://r4ds.hadley.nz/data-visualize>

The **`palmerpenguins`** package includes the penguins dataset containing body measurements for penguins on three islands in the Palmer Archipelago, and the **`ggthemes`** package, which offers a colorblind safe color palette.

```{r}
library(palmerpenguins)
library(ggthemes)
penguins
str(penguins)

```
Do penguins with longer flippers weigh more or less than penguins with shorter flippers? What does the relationship between flipper length and body mass look like? Is it positive? Negative? Linear? Nonlinear? Does the relationship vary by the species of the penguin? How about by the island where the penguin lives?

Our ultimate goal is to recreate a visualization displaying the relationship between flipper lengths and body masses of these penguins, taking into consideration the species of the penguin.

Step 1: Creating a ggplot

```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
)
```

Step 2: Adding aesthetics and layers

```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
)+
  geom_point()

# Is the relationship between flipper lengths and body masses of these penguins depending on species? 
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g, color=species)
)+
  geom_point()

# Adding a linear regression line to each specy as a new geom or a new layer ((aesthetic color in mapping are defined at the global level))
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g, color = species) 
) +
  geom_point() +
  geom_smooth(method = "lm")

# Adding a regression line for all species (aesthetic color in geom_point() is defined at the local level)
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
) +
  geom_point(mapping = aes(color = species)) +
  geom_smooth(method = "lm")

# Improving the graph looking: labels, themes, size
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
) +
  geom_point(aes(color = species, shape = species)) +
  geom_smooth(method = "lm") +
  labs(
    title = "Body mass and flipper length",
    subtitle = "Dimensions for Adelie, Chinstrap, and Gentoo Penguins",
    x = "Flipper length (mm)", y = "Body mass (g)",
    color = "Species", shape = "Species"
  ) +
  scale_color_colorblind()
```


##### **Extra practice**: Please figure out the meaning of the following R code, and the information from the output plots.

```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
) +
  geom_point(mapping = aes(color = bill_depth_mm)) +
  geom_smooth() # default is loess smooth line

ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g, color = island)
) +
  geom_point() +
  geom_smooth(se = FALSE) #se:confidence interval

#Density plots
ggplot(penguins, aes(x = body_mass_g, color = species)) +
  geom_density(linewidth = 0.75)

# Three variables
ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) +
  geom_point(aes(color = species, shape = species)) +
  facet_wrap(~island)
```



Let's start your R journey! 


